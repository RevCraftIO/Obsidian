## フェーズ２：Web APIでのユーザー登録、認証、ユーザー情報取得

---

### データ転送オブジェクト設計

#### 認証関連DTO
| ファイル名 | 用途 | 主要プロパティ |
|-----------|------|---------------|
| `RegisterRequestDto` | 新規ユーザー登録 | UserName, Password, LastName, FirstName |
| `LoginRequestDto` | ログイン認証 | UserName, Password, RememberMe |
| `AuthResponseDto` | 認証結果返却 | Token, Expires, UserInfo |

#### ユーザー操作DTO
| ファイル名 | 用途 | 主要プロパティ |
|-----------|------|---------------|
| `UpdateLoginIdRequestDto` | ログインID変更 | CurrentUserName, NewUserName |
| `UpdatePasswordRequestDto` | パスワード変更 | CurrentPassword, NewPassword |
| `UpdateProfileRequestDto` | 表示名変更 | LastName, FirstName |
| `UserResponseDto` | ユーザーの返却 | ... |

---

### APIエンドポイント設計

#### 認証コントローラー (`AuthController`)
|メソッド|パス|認証要否|機能|
|---|---|---|---|
|POST|`/api/auth/register`|❌|新規ユーザー登録|
|POST|`/api/auth/login`|❌|ログイン（認証用 Cookie を発行）|
|POST|`/api/auth/logout`|✔️|ログアウト（認証 Cookie のクリア）|
|GET|`/api/auth/me`|✔️|自身の認証情報確認（ユーザー名返却など）|

#### ユーザーコントローラー (`UserController`)
|メソッド|パス|認証要否|機能|
|---|---|---|---|
|GET|`/api/users`|✔️|全ユーザー一覧の取得|
|GET|`/api/users/{userId}`|✔️|指定ユーザー（ID）情報の取得|
|GET|`/api/users?username={name}`|✔️|指定ユーザー（ログインID）情報の取得|
|GET|`/api/users?displayName={name}`|✔️|指定ユーザー（表示名）情報の取得|
|PATCH|`/api/users/{userId}`|✔️|指定ユーザー情報の部分更新（ログインID／表示名／パスワードなどをリクエストボディで指定）|
|PATCH|`/api/users/me`|✔️|自身のユーザー情報の部分更新|
|DELETE|`/api/users/{userId}`|✔️|指定ユーザーの削除|

---

### 認証フロー設計

1. **ログイン処理**
   - ユーザー認証状態の有効期間は30分間
   - 連続5回失敗でアカウントロックアウト（10分間）
   - 認証成功時に最終ログイン日時を更新

2. **パスワードポリシー**
   - 最小長8文字
   - 大文字/小文字/数字の組み合わせ必須
   - ユーザー名を含むパスワードを禁止

3. **セッション管理**
   - クッキーにHttpOnlyとSecureフラグを設定
   - 同一ユーザーの複数端末ログインを許可

---

### エラーハンドリング方針

| エラー種別 | HTTPステータス | 対応方針 |
|-----------|---------------|----------|
| 認証失敗 | 401 Unauthorized | 失敗回数をカウントアップ |
| 権限不足 | 403 Forbidden | 管理者権限が必要な操作で発生 |
| バリデーションエラー | 400 Bad Request | 入力値不備の詳細を返却 |
| 競合状態 | 409 Conflict | 同時更新検出時に発生 |
| アカウントロック | 423 Locked | ロックアウト期間を明示 |

---

### 監査ログ要件

以下の操作をJSONファイルに記録：
- ユーザー登録/削除
- パスワード変更
- ログイン失敗
- 管理者操作

ログ項目：
- 操作日時（UTC）
- 実行ユーザー
- 操作種別
- 影響を受けたユーザー
- IPアドレス

---

### セキュリティ対策

1. **データ保護**
   - パスワードハッシュにPBKDF2アルゴリズム適用
   - 感情報をログ出力禁止

2. **CSRF対策**
   - クッキーにSameSite=Laxを設定
   - 状態変更操作にAnti-Forgeryトークン要求

3. **ヘッダーセキュリティ**
   - HSTS有効化
   - X-Content-Type-Options設定

---

### パフォーマンス最適化

1. **JSONファイル操作**
   - メモリキャッシュで読み込み回数を削減
   - 非同期I/Oを徹底適用

2. **ロック戦略**
   - ユーザー単位の細粒度ロックを採用
   - ロック待機タイムアウトを設定（500ms）

3. **バッチ処理**
   - ユーザー一括更新をトランザクション管理
   - 定期的なデータ整合性チェックを実施

---

### テスト戦略

| テスト種別 | 実施内容 | 検証ツール |
|-----------|----------|------------|
| 単体テスト | ビジネスロジック検証 | xUnit |
| 統合テスト | APIエンドポイント検証 | Postman |
| 負荷テスト | 同時認証処理検証 | k6 |
| セキュリティテスト | OWASPチェックリスト | ZAP |

---

### 移行戦略

1. **バージョン管理**
   - JSONスキーマ変更時にバージョニング
   - 自動マイグレーションスクリプトを用意

2. **フェイルセーフ**
   - 更新前にバックアップ自動作成
   - 整合性チェック失敗時にロールバック

3. **監視項目**
   - ファイルサイズ増加率
   - 認証処理遅延時間
   - ロック競合発生率