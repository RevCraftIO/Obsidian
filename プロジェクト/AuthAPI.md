# ASP.NET Core Identity 学習カリキュラム（初学者向け、JSONファイル永続化）

このカリキュラムは、ASP.NET Core Identityをステップバイステップで学習するためのものです。初学者の方でも無理なく進められるよう、簡単な実装から始め、最終的にUIまで実装する流れで構成します。SQLは使用せず、JSONファイルにユーザー情報を永続化します。

## フェーズ１：ASP.NET Core Web APIの基本とIdentityの導入
[[AuthAPI-Phase1]]

1.  **ASP.NET Core Web APIプロジェクトの作成**
    - `Visual Studio 2022` を使用して、新しいASP.NET Core Web APIプロジェクトを作成します。
    - プロジェクトの基本的な構成（Controllers, Program.csなど）を理解します。
    - 動作確認として、簡単なAPIエンドポイント（例：Hello World）を作成し、動作を確認します。

2.  **JSONファイル永続化のためのデータサービス準備**
    - ユーザー情報などをJSONファイルに保存・読み込みするための独自のデータサービス（例：`UserService`）を作成します。
    - ユーザー情報を保持するモデルクラスを定義します。
        - AppUser : IdentityUser\<Guid>
        - UserData (永続化用)
    - `appsettings.json`にJSONファイルのパスを設定します。
    - データサービスを`Program.cs`でサービスとして登録します。

3.  **ASP.NET Core Identityの導入**
    - NuGetパッケージマネージャーを使用して、Identity関連のパッケージ（`Microsoft.AspNetCore.Identity`）をインストールします。
    - カスタムのユーザーデータストア（`IUserStore<TUser>`と`IUserPasswordStore<TUser>`などを実装）を作成し、JSONファイルへの読み書き処理を実装します。
    - `Program.cs`でIdentityサービスを登録する際に、カスタムのユーザーデータストアを指定します。
    - `AddDefaultIdentity<AppUser>()`を使用し、`.AddUserStore<UserStore>()`のようにカスタムストアを登録します。

4.  **JSONファイルへの初期データ書き込み**
    - 初回起動時に必要なJSONファイルを生成し、初期データを書き込むコードを実装します。
    - 初期ユーザー（管理者など）を作成し、JSONファイルに保存します。

## フェーズ２：Web APIでのユーザー登録と認証
[[AuthAPI-Phase2]]

5.  **ユーザー登録APIの実装**
    - ユーザー登録に必要なデータ（ユーザー名、パスワードなど）を受け取るためのモデルクラス（例：`RegisterRequestDto`）を作成します。
    - 新しいAPIコントローラー（例：`AuthController`）を作成します。
    - ユーザー登録のエンドポイント（例：`/api/auth/register`）を実装します。
    - `UserManager`サービスを使用して、新しいユーザーを作成し、データサービスを通じてJSONファイルに保存します。
    - 登録の成否に応じて適切なレスポンスを返します。

6.  **ユーザー認証（ログイン）APIの実装**
    - ログインに必要なデータ（ユーザー名またはメールアドレス、パスワード）を受け取るためのモデルクラス（例：`LoginRequestDto`）を作成します。
    - 認証のエンドポイント（例：`/api/auth/login`）を実装します。
    - `SignInManager`サービスを使用して、ユーザーの認証を行います。
    - 認証に成功した場合、クッキーを生成して返します。
    - 認証の失敗時にはエラーレスポンスを返します。

7.  **認証済みユーザー情報の取得APIの実装（認証のテスト）**
    - 認証が必要なAPIエンドポイント（例：`/api/user/info`）を作成します。
    - `[Authorize]`属性を使用して、このエンドポイントへのアクセスを認証されたユーザーのみに制限します。
    - `User`プロパティを通じて、認証されたユーザーの情報を取得し、レスポンスとして返します。

## フェーズ３：発展的な内容

8.  **役割ベースの認証（Role-Based Authorization）の実装**
    - ユーザーの役割をJSONファイルに保存し、管理する仕組みをデータサービスに実装します。
    - カスタムのロールストア（`IRoleStore<TRole>`を実装）を作成し、`Program.cs`で登録します。
    - `[Authorize(Roles = "Admin")]`のように、役割に基づいてAPIエンドポイントへのアクセスを制御します。

9.  **Identityのカスタマイズ**
    - カスタムのユーザーモデル (`AppUser`) を拡張して、カスタムのユーザープロパティを追加し、データサービスでの読み書き処理を実装します。
    - 必要に応じて、`IdentityErrorDescriber`を実装してエラーメッセージをカスタマイズします。
    - パスワードポリシーやロックアウト設定などを`IdentityOptions`でカスタマイズします。

## フェーズ４：UIの実装（Razor PagesまたはMVC）

10. **ASP.NET Core UIプロジェクトの作成**
    - Visual Studioまたは.NET CLIを使用して、新しいASP.NET Core Webアプリ（Razor PagesまたはMVC）プロジェクトをソリューションに追加します。

11. **UIプロジェクトでのIdentityのセットアップ**
    - UIプロジェクトにもIdentity関連のパッケージ（`Microsoft.AspNetCore.Identity`）をインストールします。
    - UIプロジェクトの`Program.cs`でもIdentityサービスを登録し、Web APIプロジェクトと同様のカスタムユーザーデータストアを指定します。

12. **ユーザー登録UIの実装**
    - ユーザー登録用のRazor PageまたはViewとControllerを作成します。
    - フォームを作成し、ユーザーが登録に必要な情報を入力できるようにします。
    - フォームの送信処理を実装し、Web APIの登録エンドポイントを呼び出します。
    - 登録結果に応じて、ユーザーにフィードバックを表示します。

13. **ユーザーログインUIの実装**
    - ユーザーログイン用のRazor PageまたはViewとControllerを作成します。
    - フォームを作成し、ユーザーがログインに必要な情報を入力できるようにします。
    - フォームの送信処理を実装し、Web APIのログインエンドポイントを呼び出し、認証クッキーを設定します。
    - ログインの成否に応じて、ユーザーにフィードバックやリダイレクトを行います。

14. **認証が必要なUIの実装**
    - 認証されたユーザーのみがアクセスできるRazor PageまたはViewを作成します。
    - 必要に応じて、Web APIの認証が必要なエンドポイントを呼び出し、データを表示します。
    - ログアウト機能の実装（認証クッキーのクリア）。

このカリキュラムでは、Entity Framework Coreの`DbContext`の代わりに、JSONファイルへの永続化を扱うカスタムのデータサービスとユーザーデータストアを実装する流れになります。Web APIの実装と発展的な内容を先に学び、最後にUIを実装する流れに修正しました。各ステップで実際にコードを書き、動作を確認しながら進めてください。頑張ってください！