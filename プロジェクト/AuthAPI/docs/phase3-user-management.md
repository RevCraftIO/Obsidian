# フェーズ3：ユーザー管理

## 目次
1. [ユーザー管理機能の実装](#ユーザー管理機能の実装)
2. [監査ログの実装](#監査ログの実装)
3. [検索機能の実装](#検索機能の実装)

---

## ユーザー管理機能の実装

### 1.1 データモデル

#### ユーザー登録リクエスト
| 項目 | 型 | 必須 | 説明 |
|------|-----|------|------|
| UserName | string | ○ | ユーザー名（ログインID） |
| Password | string | ○ | パスワード |
| LastName | string | ○ | 姓 |
| FirstName | string | ○ | 名 |

#### ログインID更新リクエスト
| 項目 | 型 | 必須 | 説明 |
|------|-----|------|------|
| CurrentUserName | string | ○ | 現在のユーザー名 |
| NewUserName | string | ○ | 新しいユーザー名 |

#### パスワード更新リクエスト
| 項目 | 型 | 必須 | 説明 |
|------|-----|------|------|
| CurrentPassword | string | ○ | 現在のパスワード |
| NewPassword | string | ○ | 新しいパスワード |

#### 表示名更新リクエスト
| 項目 | 型 | 必須 | 説明 |
|------|-----|------|------|
| LastName | string | ○ | 新しい姓 |
| FirstName | string | ○ | 新しい名 |

### 1.2 APIエンドポイント

#### ユーザー登録
- **メソッド**: POST
- **パス**: `/api/user/register`
- **権限**: Admin
- **機能**: 新規ユーザーの登録
- **監査ログ**: ユーザー登録イベントを記録

#### ユーザー一覧取得
- **メソッド**: GET
- **パス**: `/api/user`
- **権限**: Admin
- **クエリパラメータ**:
  - username: ユーザー名によるフィルタリング
  - displayName: 表示名によるフィルタリング

#### ユーザー詳細取得
- **メソッド**: GET
- **パス**: `/api/user/{userId}`
- **権限**: Admin
- **機能**: 指定されたユーザーの詳細情報を取得

#### ユーザー情報更新
- **メソッド**: PATCH
- **パス**: `/api/user/{userId}`
- **権限**: Admin
- **機能**: ユーザー情報の部分更新
- **監査ログ**: ユーザー更新イベントを記録

#### ユーザー削除
- **メソッド**: DELETE
- **パス**: `/api/user/{userId}`
- **権限**: Admin
- **機能**: ユーザーの削除
- **監査ログ**: ユーザー削除イベントを記録

## 監査ログの実装

### 2.1 監査ログモデル

#### 監査ログエントリ
| 項目 | 型 | 説明 |
|------|-----|------|
| Id | Guid | ログエントリの一意識別子 |
| Timestamp | DateTime | イベント発生時刻 |
| Action | string | 実行されたアクション |
| PerformedBy | string | アクション実行者 |
| TargetUserId | Guid? | 対象ユーザーID |
| IpAddress | string | アクション実行元IPアドレス |
| Details | string | 詳細情報 |

### 2.2 監査ログイベント

| イベント | 説明 | 記録項目 |
|----------|------|----------|
| UserRegistration | ユーザー登録 | ユーザーID, 実行者 |
| UserUpdate | ユーザー情報更新 | ユーザーID, 実行者 |
| UserDeletion | ユーザー削除 | ユーザーID, 実行者 |
| PasswordChange | パスワード変更 | ユーザーID, 実行者 |
| LoginFailure | ログイン失敗 | ユーザー名, IPアドレス |

### 2.3 監査ログの保存
- ファイルベースのJSONストレージ
- スレッドセーフな実装
- 自動バックアップ機能

## 検索機能の実装

### 3.1 検索条件

| 項目 | 型 | 説明 |
|------|-----|------|
| UserName | string | ユーザー名による検索 |
| DisplayName | string | 表示名による検索 |
| CreatedFrom | DateTime? | 作成日時（開始） |
| CreatedTo | DateTime? | 作成日時（終了） |
| IsLocked | bool? | ロック状態によるフィルタリング |

### 3.2 検索機能の特徴
- 複数条件の組み合わせ検索
- 部分一致検索
- 日付範囲検索
- 状態によるフィルタリング

## 次のステップ
- [メインドキュメント](../AuthAPI.md)に戻る
- [デプロイメント手順](deployment.md)を確認する 